box: ruby:2.4.0
init:
build:
  steps:
    - script:
        name: install nodejs v7
        code: |
          curl -sL https://deb.nodesource.com/setup_7.x | bash -
          apt install -y nodejs
    - script:
        name: install yarn
        code: npm install -g yarn
    - script:
        name: install npm packages
        code: yarn install
    - bundle-install
    - script:
        name: middleman build
        code: bundle exec middleman build
deploy:
  steps:
    - install-packages:
        packages: rsync
    - script:
        name: install nodejs v7
        code: |
          curl -sL https://deb.nodesource.com/setup_7.x | bash -
          apt install -y nodejs
    - script:
        name: install yarn
        code: npm install -g yarn
    - script:
        name: install npm packages
        code: yarn install
    - bundle-install
    - add-ssh-key:
        host: unasuke.com
        keyname: deploy
    - add-to-known_hosts:
        hostname: unasuke.com
        fingerprint: $FINGERPRINT
    - script:
        name: middleman build
        code: bundle exec middleman build
    - script:
        name: middleman deploy
        code: bundle exec middleman deploy
